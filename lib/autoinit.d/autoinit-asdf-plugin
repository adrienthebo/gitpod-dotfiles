#!/usr/bin/env bash

FUNCTION_DIR="$(realpath "$(dirname "${BASH_SOURCE[0]}")/..")"
source "$FUNCTION_DIR/functions.sh"

AUTOINIT_D="$(realpath "$(dirname "${BASH_SOURCE[0]}")")"
AUTOINIT_ASDF="${AUTOINIT_D}/autoinit-asdf"

__autoinit_asdf_plugin_init() {
    local plugin="$1"
    local latest="$("$AUTOINIT_ASDF" list "$plugin" | tail -n1 | tr -d '[:space:]')"
    cat - <<EOD
$AUTOINIT_ASDF autorun asdf reshim "$plugin" "$latest"
EOD
}


__autoinit_asdf_plugin_install() {
    local plugin="$1"

    "$AUTOINIT_ASDF" plugin add "$plugin"
    "$AUTOINIT_ASDF" install "$plugin" latest

    local latest="$("$AUTOINIT_ASDF" list "$plugin" | tail -n1 | tr -d '[:space:]')"

    "$AUTOINIT_ASDF" global "$plugin" "$latest"
    "$AUTOINIT_ASDF" reshim "$plugin" "$latest"
}


__autoinit_asdf_plugin_is_active() {
    local plugin="$1"

    [[ $(command -v "$plugin") = "$ASDF_DIR/shims/$plugin" ]]
    return $?
}


__autoinit_asdf_plugin_is_installed() {
    local plugin="$1"

    "$AUTOINIT_ASDF" list "$plugin" 2>/dev/null 1>/dev/null
    return $?
}


__autoinit_asdf_plugin_is_ready() {
    local plugin="$1"

    if "$AUTOINIT_ASDF" is-ready && __autoinit_asdf_plugin_is_installed "$plugin" && ! __autoinit_asdf_plugin_is_active "$plugin" && ! command -v "$plugin" 1>/dev/null; then
        return 0
    else
        return 1
    fi
}


__autoinit_asdf_plugin_autoload() {
    local plugin="$1"

    if ! __autoinit_asdf_plugin_is_installed "$plugin"; then
        __autoinit_asdf_plugin_install "$plugin"
        rc=$?
        if [[ $rc -ne 0 ]]; then
            return $rc
        fi
    fi

    if ! __autoinit_asdf_plugin_is_active "$plugin"; then
        eval "$(__autoinit_asdf_plugin_init "$plugin")"
    fi
}

__autoinit_asdf_plugin_autorun() {
    local plugin="$1"
    shift
    local argv="$@"

    __autoinit_asdf_plugin_autoload "$plugin" || return 254

    $argv
    return $?
}

main() {
    local plugin="$1"
    shift
    local cmd="$1"
    shift

    case "$cmd" in
        "init")
            __autoinit_asdf_plugin_init "$plugin"
            ;;

        "install")
            __autoinit_asdf_plugin_install "$plugin"
            ;;

        "is-active")
            __autoinit_asdf_plugin_is_active "$plugin"
            ;;

        "is-installed")
            __autoinit_asdf_plugin_is_installed "$plugin"
            ;;

        "is-ready")
            __autoinit_asdf_plugin_is_ready "$plugin"
            ;;

        "autoload")
            __autoinit_asdf_plugin_autoload "$plugin"
            ;;

        "autorun")
            __autoinit_asdf_plugin_autorun "$plugin" $@
            exit $?
            ;;
        *)
            echo "Error: Unknown command '$cmd'"
            echo "Usage: $0 PLUGIN [init|install|is-active|is-installed]"
            ;;
    esac

}


if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    # shellcheck disable=SC2068
    main $@
fi